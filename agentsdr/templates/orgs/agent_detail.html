{% extends "layout.html" %}

{% block title %}{{ agent.name }} - {{ organization.name }}{% endblock %}

{% block content %}
<div class="space-y-8" x-data="{
    fetchingEmails: false,
    testing: false,
    fetchCriteria: 'last_24_hours',
    customCount: 10,
    error: null
}" data-agent-type="{{ agent.agent_type }}">
    <!-- Enhanced Header -->
    <div class="card-gradient rounded-xl shadow-lg overflow-hidden">
        <div class="px-8 py-8 relative">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <span class="text-3xl">
                            {% if agent.agent_type == 'email_summarizer' %}📧
                            {% elif agent.agent_type == 'hubspot_data' %}🔗
                            {% else %}🤖{% endif %}
                        </span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">{{ agent.name }}</h1>
                        <p class="text-white/80 text-lg">{{ agent.agent_type.replace('_', ' ').title() }}</p>
                        <div class="mt-4 mb-2">
                            <div class="inline-block p-1 rounded-2xl" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);">
                                <div id="agentStatusBadge" class="inline-flex items-center px-6 py-3 rounded-xl text-sm font-bold shadow-xl transition-all duration-300" 
                                     style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: 2px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
                                    <span class="w-3 h-3 rounded-full mr-3 animate-pulse" style="background: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);"></span>
                                    <span class="tracking-wide">Active & Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <a href="{{ url_for('orgs.list_agents', org_slug=organization.slug) }}" 
                       class="btn-gradient py-3 px-6 rounded-xl font-semibold transition-all duration-300 hover:scale-105">
                        ← Back to Agents
                    </a>
                </div>
            </div>
            <div class="absolute top-4 right-4 text-white/10 text-6xl float-up">⚡</div>
        </div>
    </div>

    {% if agent.agent_type == 'email_summarizer' %}
    <!-- Email Summarizer Interface -->
    <div class="bg-white rounded-xl shadow-lg p-8" data-agent-type="email_summarizer">
        <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                <span class="text-white text-lg">📧</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Email Summarizer</h3>
        </div>

        {% if not gmail_connected %}
        <!-- Gmail Connection Required -->
        <div class="text-center py-12">
            <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-3xl text-white">📧</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-4">Gmail Connection Required</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                To start summarizing emails, you need to connect your Gmail account. This will allow the agent to access and summarize your emails.
            </p>
            <button onclick="connectGmail('{{ organization.slug }}', '{{ agent.id }}')" 
                    class="btn-gradient inline-flex items-center py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 pulse-glow">
                🔗 Connect Gmail Account
            </button>
        </div>
        {% else %}
        <!-- Gmail Connected - Email Fetching Options -->
        <div class="space-y-6">
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">✓</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-green-800">Gmail Connected</h4>
                        <p class="text-green-600 text-sm">Your Gmail account is connected and ready to use.</p>
                    </div>
                </div>
                <button onclick="testConnection()" 
                        :disabled="$store.emailData.testing"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                    <span x-show="!$store.emailData.testing">Test Connection</span>
                    <span x-show="$store.emailData.testing">Testing...</span>
                </button>
            </div>

            <!-- Email Fetching Options -->
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Choose Email Criteria</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 reveal-list">
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'last_24_hours' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'last_24_hours'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Last 24 Hours</div>
                        <div class="text-sm text-gray-600">Get emails from the past day</div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'last_7_days' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'last_7_days'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Last 7 Days</div>
                        <div class="text-sm text-gray-600">Get emails from the past week</div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'latest_n' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'latest_n'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Latest N Emails</div>
                        <div class="text-sm text-gray-600">Get the most recent emails</div>
                        <div x-show="$store.emailData.fetchCriteria === 'latest_n'" class="mt-2">
                            <input type="number" x-model.number="$store.emailData.customCount" min="1" max="100" 
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                            <span class="text-sm text-gray-600 ml-1">emails</span>
                        </div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'oldest_n' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'oldest_n'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Oldest N Emails</div>
                        <div class="text-sm text-gray-600">Get the oldest unread emails</div>
                        <div x-show="$store.emailData.fetchCriteria === 'oldest_n'" class="mt-2">
                            <input type="number" x-model.number="$store.emailData.customCount" min="1" max="100" 
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                            <span class="text-sm text-gray-600 ml-1">emails</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Fetch Button -->
            <div class="text-center">
                <button onclick="fetchAndSummarizeEmails()" 
                        :disabled="$store.emailData.fetchingEmails"
                        class="btn-gradient inline-flex items-center py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105"
                        :class="{ 'opacity-50 cursor-not-allowed': $store.emailData.fetchingEmails }">
                    <span x-show="!$store.emailData.fetchingEmails">📧 Fetch & Summarize Emails</span>
                    <span x-show="$store.emailData.fetchingEmails" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </div>

            <!-- Error Display -->
            <div x-show="$store.emailData.error" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <span class="text-red-500 mr-2">❌</span>
                    <span class="text-red-700" x-text="$store.emailData.error"></span>
                </div>
            </div>

            <!-- Summaries Container -->
            <div id="summaries-container" class="mt-8">
                <!-- Summaries will be displayed here -->
            </div>

            <!-- Automated Scheduling Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">⏰</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">Automated Daily Summaries</h3>
                </div>

                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-white text-xs">ℹ️</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-blue-900 mb-1">How it works</h4>
                                <p class="text-blue-700 text-sm">
                                    Set up automated daily email summaries that will be sent to your email at your chosen time. 
                                    The system will automatically fetch emails from the last 24 hours and send you a summary.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Form -->
                    <div class="space-y-6">
                        <!-- Email Criteria Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">📧 Email Criteria</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Selection</label>
                                    <select id="emailCriteria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateEmailCriteriaOptions()">
                                        <option value="last_24_hours">Last 24 Hours</option>
                                        <option value="last_7_days">Last 7 Days</option>
                                        <option value="custom_hours">Custom Hours Back</option>
                                        <option value="latest_n">Latest N Emails</option>
                                        <option value="oldest_n">Oldest N Emails</option>
                                    </select>
                                </div>
                                <div id="customCriteriaContainer" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2" id="customCriteriaLabel">Value</label>
                                    <input type="number" id="customCriteriaValue" min="1" max="168" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Frequency Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">🕐 Schedule Frequency</h4>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                                        <select id="scheduleFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateFrequencyOptions()">
                                            <option value="daily" selected>Daily</option>
                                            <option value="once">One Time</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div id="timeContainer">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                        <input type="time" id="scheduleTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div id="datetimeContainer" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">📅 Date & Time</label>
                                    <input type="datetime-local" id="oneTimeDatetime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <p class="text-sm text-gray-500 mt-1">Select the exact date and time to send the email summary</p>
                                </div>
                                
                                <div id="frequencyOptionsContainer" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2" id="frequencyOptionsLabel">Day</label>
                                    <select id="frequencyOptions" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Recipient Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">📨 Delivery Settings</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Email</label>
                                    <input type="email" id="recipientEmail" placeholder="your-email@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Next Run</label>
                                    <input type="text" id="nextRunDisplay" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" placeholder="Will be calculated when saved">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <button onclick="saveSchedule()" class="btn-gradient py-3 px-6 rounded-lg font-semibold transition-all duration-300 hover:scale-105">
                                💾 Save Schedule
                            </button>
                            <button onclick="toggleSchedule()" id="toggleScheduleBtn" class="px-8 py-5 rounded-2xl font-bold text-xl transition-all duration-500 hover:scale-105 hover:shadow-2xl min-w-[200px] flex items-center justify-center border-3 transform shadow-lg"
                                    style="background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #b91c1c; color: white; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);">
                                <div class="flex flex-col items-center">
                                    <div class="text-2xl mb-1">🔴</div>
                                    <div class="text-sm font-bold tracking-wider">INACTIVE</div>
                                    <div class="text-xs opacity-90 mt-0.5">Click to activate</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Current Schedule Display -->
                    <div id="currentSchedule" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Current Schedule</h4>
                        <div class="text-sm text-gray-600">
                            <p><strong>Time:</strong> <span id="currentTime">-</span></p>
                            <p><strong>Email:</strong> <span id="currentEmail">-</span></p>
                            <p><strong>Status:</strong> <span id="currentStatus">-</span></p>
                            <p><strong>Last Run:</strong> <span id="lastRun">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        {% endif %}
    </div>
    {% elif agent.agent_type == 'hubspot_data' %}
    <!-- Hubspot Data Interface -->
    <div class="bg-white rounded-xl shadow-lg p-8" data-agent-type="hubspot_data">
        <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                <span class="text-white text-lg">🔗</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Hubspot Data</h3>
        </div>

        {% if not hubspot_connected %}
        <!-- Hubspot Connection Required -->
        <div class="text-center py-12">
            <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-3xl text-white">🔗</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-4">Hubspot Connection Required</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                To start accessing Hubspot data, you need to connect your Hubspot account. This will allow the agent to access and analyze your CRM data.
            </p>
            <button onclick="connectHubspot('{{ organization.slug }}', '{{ agent.id }}')" 
                    class="btn-gradient inline-flex items-center py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 pulse-glow">
                🔗 Connect Hubspot Account
            </button>
        </div>
        {% else %}
        <!-- Hubspot Connected - Data Access Options -->
        <div class="space-y-6">
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">✓</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-green-800">Hubspot Connected</h4>
                        <p class="text-green-600 text-sm">Your Hubspot account is connected and ready to use.</p>
                    </div>
                </div>
                <button onclick="testHubspotConnection()" 
                        :disabled="$store.hubspotData.testing"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                    <span x-show="!$store.hubspotData.testing">Test Connection</span>
                    <span x-show="$store.hubspotData.testing">Testing...</span>
                </button>
            </div>

            <!-- Data Access Options -->
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Available Data Sources</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 reveal-list">
                    <div class="border-2 border-gray-300 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900 mb-2">📊 Contacts</div>
                        <div class="text-sm text-gray-600">Access and analyze contact information</div>
                    </div>
                    
                    <div class="border-2 border-gray-300 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900 mb-2">🏢 Companies</div>
                        <div class="text-sm text-gray-600">Company data and insights</div>
                    </div>
                    
                    <div class="border-2 border-gray-300 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900 mb-2">💼 Deals</div>
                        <div class="text-sm text-gray-600">Deal pipeline and opportunities</div>
                    </div>
                    
                    <div class="border-2 border-gray-300 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900 mb-2">📈 Analytics</div>
                        <div class="text-sm text-gray-600">Performance metrics and reports</div>
                    </div>
                </div>
            </div>

            <!-- HubSpot Contacts Preview (UI only) -->
            <div class="mt-8 border border-gray-200 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">Contacts (HubSpot)</h4>
                        <p class="text-sm text-gray-600">Real-time view will appear here after we wire the API.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input x-model="$store.hubspotData.query" type="text" placeholder="Search name or phone" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button @click="window.loadHubspotContacts()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Refresh</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Checkup Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Summary</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" x-data x-init="window.loadHubspotContacts && window.loadHubspotContacts()">
                            <template x-for="row in $store.hubspotData.filteredContacts()" :key="row.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="row.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="row.phone || '-' "></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="row.checkup_date || '-' "></td>
                                    <td class="px-6 py-4 text-sm text-gray-700" x-text="row.summary || '-' "></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                        <button @click="callContact(row)" :disabled="!row.phone || $store.hubspotData.calling" class="inline-flex items-center px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span class="mr-1">📞</span>
                                            <span x-show="!$store.hubspotData.calling">Call</span>
                                            <span x-show="$store.hubspotData.calling">Calling...</span>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="$store.hubspotData.contacts.length === 0 && !$store.hubspotData.loading">
                                <td colspan="5" class="px-6 py-8 text-center text-sm text-gray-500">No contacts yet. Sample data will be shown after connect.</td>
                            </tr>
                            <tr x-show="$store.hubspotData.loading">
                                <td colspan="5" class="px-6 py-8 text-center text-sm text-gray-500">Loading contacts…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Error Display -->
            <div x-show="$store.hubspotData.error" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <span class="text-red-500 mr-2">❌</span>
                    <span class="text-red-700" x-text="$store.hubspotData.error"></span>
                </div>
            </div>

            <!-- Call Scheduling Interface -->
            <div class="mt-8 bg-white border border-gray-200 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">📞 Call Scheduling & Automation</h4>
                            <p class="text-sm text-gray-600">Schedule calls manually or set up automatic follow-up based on check-up dates</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="$store.callSchedulingData.openScheduleModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 flex items-center">
                                <span class="mr-2">➕</span> Schedule Call
                            </button>
                            <button @click="window.loadScheduledCalls()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 flex items-center">
                                <span class="mr-2">🔄</span> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Call Scheduling Settings -->
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Check-up Threshold (Days)</label>
                            <input x-model="$store.callSchedulingData.callSettings.checkupThresholdDays" type="number" min="1" max="30" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="5">
                            <p class="text-xs text-gray-500 mt-1">Days after check-up to auto-trigger calls</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Auto-Trigger Enabled</label>
                            <div class="flex items-center">
                                <input x-model="$store.callSchedulingData.callSettings.autoTriggerEnabled" type="checkbox" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Automatically trigger calls when threshold exceeded</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Call Topic</label>
                            <select x-model="$store.callSchedulingData.callSettings.defaultCallTopic" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="follow_up">Follow-up</option>
                                <option value="appointment_reminder">Appointment Reminder</option>
                                <option value="check_in">Check-in</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-4">
                        <button @click="window.saveCallSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                            💾 Save Settings
                        </button>
                        <button @click="window.triggerOverdueCalls()" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm hover:bg-orange-700">
                            🚀 Trigger Overdue Calls
                        </button>
                        <button @click="window.loadCallStatistics()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">
                            📊 View Statistics
                        </button>
                    </div>
                </div>

                <!-- Scheduled Calls Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled For</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Check-up</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="schedule in $store.callSchedulingData.scheduledCalls" :key="schedule.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="schedule.contact_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="schedule.contact_phone"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                        <span x-text="formatDateTime(schedule.scheduled_at)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="schedule.call_topic"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="getStatusClass(schedule.call_status)" x-text="schedule.call_status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                        <span x-text="schedule.last_checkup_date ? formatDate(schedule.last_checkup_date) : 'N/A'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                        <div class="flex items-center justify-end space-x-2">
                                            <button @click="window.executeCall(schedule.id)" 
                                                    x-show="schedule.call_status === 'scheduled'"
                                                    class="px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs hover:bg-emerald-700">
                                                🚀 Execute
                                            </button>
                                            <button @click="$store.callSchedulingData.editSchedule(schedule)" 
                                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700">
                                                ✏️ Edit
                                            </button>
                                            <button @click="window.deleteSchedule(schedule.id)" 
                                                    class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700">
                                                🗑️ Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="$store.callSchedulingData.scheduledCalls.length === 0 && !$store.callSchedulingData.loadingSchedules">
                                <td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">
                                    No scheduled calls yet. Schedule your first call above!
                                </td>
                            </tr>
                            <tr x-show="$store.callSchedulingData.loadingSchedules">
                                <td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">
                                    Loading scheduled calls...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Call Statistics Dashboard -->
            <div x-show="$store.callSchedulingData.callStatistics" class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-blue-600" x-text="$store.callSchedulingData.callStatistics.total_scheduled || 0">0</div>
                    <div class="text-sm text-gray-600">Total Scheduled</div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-green-600" x-text="$store.callSchedulingData.callStatistics.total_completed || 0">0</div>
                    <div class="text-sm text-gray-600">Completed</div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-orange-600" x-text="$store.callSchedulingData.callStatistics.overdue_schedules || 0">0</div>
                    <div class="text-sm text-gray-600">Overdue</div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-purple-600" x-text="$store.callSchedulingData.callStatistics.upcoming_schedules || 0">0</div>
                    <div class="text-sm text-gray-600">Upcoming</div>
                </div>
            </div>

            <!-- Schedule Call Modal -->
            <div x-show="$store.callSchedulingData.showScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Schedule Call</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contact</label>
                                <select x-model="$store.callSchedulingData.newSchedule.contact_id" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select a contact</option>
                                    <template x-for="contact in $store.hubspotData.contacts" :key="contact.id">
                                        <option :value="contact.id" x-text="contact.name + ' (' + contact.phone + ')'"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Date & Time</label>
                                <input x-model="$store.callSchedulingData.newSchedule.scheduled_at" type="datetime-local" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Call Topic</label>
                                <select x-model="$store.callSchedulingData.newSchedule.call_topic" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="follow_up">Follow-up</option>
                                    <option value="appointment_reminder">Appointment Reminder</option>
                                    <option value="check_in">Check-in</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Auto-Trigger</label>
                                <div class="flex items-center">
                                    <input x-model="$store.callSchedulingData.newSchedule.auto_trigger_enabled" type="checkbox" 
                                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Enable automatic triggering</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-end space-x-3 mt-6">
                            <button @click="$store.callSchedulingData.showScheduleModal = false; $store.callSchedulingData.resetNewSchedule()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-400">
                                Cancel
                            </button>
                            <button @click="window.createSchedule()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                                Save Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coming Soon Notice -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-white text-xs">ℹ️</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-blue-900 mb-1">Advanced Features Coming Soon</h4>
                        <p class="text-blue-700 text-sm">
                            We're working on advanced data analysis, automated reporting, and AI-powered insights for your Hubspot data. Stay tuned!
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Other Agent Types -->
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-3xl text-white">🤖</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-4">{{ agent.agent_type.replace('_', ' ').title() }}</h3>
        <p class="text-gray-600 text-lg mb-8">
            This agent type is not yet implemented. Coming soon!
        </p>
    </div>
    {% endif %}
</div>

<script>
async function connectGmail(orgSlug, agentId) {
    try {
        // Redirect to Gmail OAuth
        window.location.href = `/orgs/${orgSlug}/agents/${agentId}/gmail/auth`;
    } catch (error) {
        console.error('Error connecting Gmail:', error);
        alert('Failed to connect Gmail. Please try again.');
    }
}

async function connectHubspot(orgSlug, agentId) {
    try {
        // Redirect to Hubspot OAuth
        window.location.href = `/orgs/${orgSlug}/agents/${agentId}/hubspot/auth`;
    } catch (error) {
        console.error('Error connecting Hubspot:', error);
        alert('Failed to connect Hubspot. Please try again.');
    }
}

function fetchAndSummarizeEmails() {
    const alpine = Alpine.store('emailData');
    alpine.fetchingEmails = true;
    alpine.error = null;

    const criteria = {
        type: alpine.fetchCriteria,
        count: alpine.customCount
    };

    console.log('Sending criteria:', criteria);
    console.log('customCount value:', alpine.customCount, 'type:', typeof alpine.customCount);

    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/emails/summarize`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(criteria)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alpine.error = data.error;
        } else if (data.success) {
            // Display summaries directly on this page
            showToast(`Found ${data.count} emails!`, 'success');
            displaySummaries(data.summaries, data.criteria_type);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alpine.error = `Failed to fetch and summarize emails: ${error.message}`;
    })
    .finally(() => {
        alpine.fetchingEmails = false;
    });
}

function displaySummaries(summaries, criteriaType) {
    // Create summaries display HTML
    const summariesHtml = summaries.map((summary, index) => `
        <div class="p-6 hover:bg-gray-50 transition-colors border-b border-gray-200">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">${summary.sender ? summary.sender[0].toUpperCase() : '?'}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">${summary.sender || 'Unknown'}</h3>
                            <p class="text-sm text-gray-500">${summary.date || 'Unknown date'}</p>
                        </div>
                    </div>
                    
                    <h4 class="font-medium text-gray-900 mb-2">${summary.subject || 'No Subject'}</h4>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-3">
                        <p class="text-gray-700 leading-relaxed">${summary.summary || 'No summary available'}</p>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Update the summaries container
    const summariesContainer = document.getElementById('summaries-container');
    if (summariesContainer) {
        summariesContainer.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-8 py-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Email Summaries</h2>
                            <p class="text-gray-600 mt-1">${summaries.length} email${summaries.length !== 1 ? 's' : ''} summarized</p>
                        </div>
                        <div class="text-sm text-gray-500">
                            Criteria: ${criteriaType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </div>
                    </div>
                </div>
                
                <div class="divide-y divide-gray-200">
                    ${summariesHtml}
                </div>
            </div>
        `;
        
        // Scroll to summaries
        summariesContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

function testConnection() {
    const alpine = Alpine.store('emailData');
    alpine.testing = true;
    alpine.error = null;
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/emails/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`✓ Gmail connection working! Email: ${data.email}, Total messages: ${data.total_messages}`, 'success');
        } else {
            alpine.error = data.error || 'Connection test failed';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alpine.error = `Connection test failed: ${error.message}`;
    })
    .finally(() => {
        alpine.testing = false;
    });
}

function testHubspotConnection() {
    const alpine = Alpine.store('hubspotData');
    alpine.testing = true;
    alpine.error = null;
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/hubspot/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`✓ Hubspot connection working! Found ${data.total_contacts} contacts.`, 'success');
        } else {
            alpine.error = data.error || 'Connection test failed';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alpine.error = `Connection test failed: ${error.message}`;
    })
    .finally(() => {
        alpine.testing = false;
    });
}

// Initialize Alpine.js store
document.addEventListener('alpine:init', () => {
    Alpine.store('emailData', {
        fetchingEmails: false,
        testing: false,
        fetchCriteria: 'last_24_hours',
        customCount: 10,
        error: null
    });
    
    Alpine.store('hubspotData', {
        testing: false,
        error: null,
        loading: false,
        query: '',
        calling: false,
        contacts: [],
        filteredContacts() {
            const q = this.query.trim().toLowerCase();
            if (!q) return this.contacts;
            return this.contacts.filter(c =>
                (c.name || '').toLowerCase().includes(q) || (c.phone || '').toLowerCase().includes(q)
            );
        }
    });
    
    Alpine.store('callSchedulingData', {
        showScheduleModal: false,
        loadingSchedules: false,
        error: null,
        scheduledCalls: [],
        callStatistics: null,
        callSettings: {
            checkupThresholdDays: 5,
            autoTriggerEnabled: true,
            defaultCallTopic: 'follow_up'
        },
        newSchedule: {
            contact_id: '',
            scheduled_at: '',
            call_topic: 'follow_up',
            auto_trigger_enabled: true
        },
        resetNewSchedule() {
            this.newSchedule = {
                contact_id: '',
                scheduled_at: '',
                call_topic: 'follow_up',
                auto_trigger_enabled: true
            };
        },
        openScheduleModal() {
            this.showScheduleModal = true;
            // Set default scheduled time to current time + 1 hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            this.newSchedule.scheduled_at = now.toISOString().slice(0, 16);
        },
        editSchedule(schedule) {
            this.newSchedule = { ...schedule };
            this.showScheduleModal = true;
        }
    });
    
    // Initialize frequency options on page load
    updateFrequencyOptions();
});

// UI Helper functions
function updateEmailCriteriaOptions() {
    const criteria = document.getElementById('emailCriteria').value;
    const container = document.getElementById('customCriteriaContainer');
    const label = document.getElementById('customCriteriaLabel');
    const input = document.getElementById('customCriteriaValue');
    
    if (criteria === 'custom_hours') {
        container.style.display = 'block';
        label.textContent = 'Hours Back';
        input.placeholder = 'Enter hours (1-168)';
        input.max = '168';
    } else if (criteria === 'latest_n' || criteria === 'oldest_n') {
        container.style.display = 'block';
        label.textContent = 'Number of Emails';
        input.placeholder = 'Enter count (1-100)';
        input.max = '100';
    } else {
        container.style.display = 'none';
    }
}

function updateFrequencyOptions() {
    const frequency = document.getElementById('scheduleFrequency').value;
    const container = document.getElementById('frequencyOptionsContainer');
    const label = document.getElementById('frequencyOptionsLabel');
    const select = document.getElementById('frequencyOptions');
    const timeContainer = document.getElementById('timeContainer');
    const datetimeContainer = document.getElementById('datetimeContainer');
    
    console.log('Updating frequency options for:', frequency);
    
    if (frequency === 'once') {
        // Show datetime picker for one-time schedules
        timeContainer.style.display = 'none';
        datetimeContainer.style.display = 'block';
        container.style.display = 'none';
        
        // Set default to current time + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const datetimeLocal = now.toISOString().slice(0, 16);
        document.getElementById('oneTimeDatetime').value = datetimeLocal;
        
    } else if (frequency === 'weekly') {
        timeContainer.style.display = 'block';
        datetimeContainer.style.display = 'none';
        container.style.display = 'block';
        label.textContent = 'Day of Week';
        select.innerHTML = `
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="7">Sunday</option>
        `;
    } else if (frequency === 'monthly') {
        timeContainer.style.display = 'block';
        datetimeContainer.style.display = 'none';
        container.style.display = 'block';
        label.textContent = 'Day of Month';
        let options = '';
        for (let i = 1; i <= 31; i++) {
            options += `<option value="${i}">${i}</option>`;
        }
        select.innerHTML = options;
    } else {
        // Daily
        timeContainer.style.display = 'block';
        datetimeContainer.style.display = 'none';
        container.style.display = 'none';
    }
}

// Scheduling functions
function saveSchedule() {
    const recipientEmail = document.getElementById('recipientEmail').value;
    const emailCriteria = document.getElementById('emailCriteria').value;
    const frequency = document.getElementById('scheduleFrequency').value;
    
    let scheduleTime = '';
    let oneTimeDatetime = '';
    
    if (frequency === 'once') {
        oneTimeDatetime = document.getElementById('oneTimeDatetime').value;
        if (!oneTimeDatetime || !recipientEmail) {
            showToast('Please fill in date/time and email fields', 'error');
            return;
        }
        // Convert to schedule_time format for consistency
        const dt = new Date(oneTimeDatetime);
        scheduleTime = dt.toTimeString().slice(0, 5); // HH:MM format
    } else {
        scheduleTime = document.getElementById('scheduleTime').value;
        if (!scheduleTime || !recipientEmail) {
            showToast('Please fill in time and email fields', 'error');
            return;
        }
    }
    
    // Build schedule data
    const scheduleData = {
        schedule_time: scheduleTime,
        recipient_email: recipientEmail,
        criteria_type: emailCriteria,
        frequency_type: frequency
    };
    
    // Add one-time datetime if applicable
    if (frequency === 'once' && oneTimeDatetime) {
        scheduleData.one_time_datetime = new Date(oneTimeDatetime).toISOString();
    }
    
    // Add criteria-specific values
    const customValue = document.getElementById('customCriteriaValue').value;
    if (emailCriteria === 'custom_hours' && customValue) {
        scheduleData.email_hours = parseInt(customValue);
    } else if ((emailCriteria === 'latest_n' || emailCriteria === 'oldest_n') && customValue) {
        scheduleData.email_count = parseInt(customValue);
    }
    
    // Add frequency-specific values
    const frequencyOption = document.getElementById('frequencyOptions');
    if (frequency === 'weekly' && frequencyOption.style.display !== 'none') {
        scheduleData.day_of_week = parseInt(frequencyOption.value);
    } else if (frequency === 'monthly' && frequencyOption.style.display !== 'none') {
        scheduleData.day_of_month = parseInt(frequencyOption.value);
    }
    
    console.log('Saving schedule:', scheduleData);
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(scheduleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Schedule saved successfully!', 'success');
            // Update status badge with agent status
            if (data.agent_is_active !== undefined) {
                updateStatusBadge(data.agent_is_active);
            }
            loadCurrentSchedule();
        } else {
            showToast(data.error || 'Failed to save schedule', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving schedule:', error);
        showToast('Failed to save schedule', 'error');
    });
}

function toggleSchedule() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge based on schedule status
            updateStatusBadge(data.is_active);
            showToast(data.is_active ? 'Schedule activated!' : 'Schedule paused!', 'success');
            loadCurrentSchedule();
        } else {
            showToast(data.error || 'Failed to toggle schedule', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling schedule:', error);
        showToast('Failed to toggle schedule', 'error');
    });
}

function loadCurrentSchedule() {
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule`)
    .then(response => response.json())
    .then(data => {
        if (data.schedule) {
            const currentSchedule = document.getElementById('currentSchedule');
            if (currentSchedule) {
                currentSchedule.classList.remove('hidden');
                document.getElementById('currentTime').textContent = data.schedule.schedule_time;
                document.getElementById('currentEmail').textContent = data.schedule.recipient_email;
                document.getElementById('currentStatus').textContent = data.agent_is_active ? 'Active' : 'Paused';
                document.getElementById('lastRun').textContent = data.schedule.last_run_at ? new Date(data.schedule.last_run_at).toLocaleString() : 'Never';
                
                // Update the status badge based on agent status
                updateStatusBadge(data.agent_is_active);
            
                // Update form fields
                const scheduleTime = document.getElementById('scheduleTime');
                const recipientEmail = document.getElementById('recipientEmail');
                if (scheduleTime) scheduleTime.value = data.schedule.schedule_time;
                if (recipientEmail) recipientEmail.value = data.schedule.recipient_email;
                
                // Update toggle button
                const toggleBtn = document.getElementById('toggleScheduleBtn');
                if (toggleBtn) {
                    if (data.agent_is_active) {
                        // ACTIVE state - working and sending emails
                        toggleBtn.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="text-2xl mb-1">🟢</div>
                                <div class="text-sm font-bold tracking-wider">ACTIVE</div>
                                <div class="text-xs opacity-90 mt-0.5">Daily emails sending</div>
                            </div>
                        `;
                        toggleBtn.className = 'px-8 py-5 rounded-2xl font-bold text-xl transition-all duration-500 hover:scale-105 hover:shadow-2xl min-w-[200px] flex items-center justify-center border-3 transform shadow-lg';
                        toggleBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        toggleBtn.style.borderColor = '#047857';
                        toggleBtn.style.color = 'white';
                        toggleBtn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.4)';
                    } else {
                        // INACTIVE state - paused and not sending emails
                        toggleBtn.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="text-2xl mb-1">🔴</div>
                                <div class="text-sm font-bold tracking-wider">INACTIVE</div>
                                <div class="text-xs opacity-90 mt-0.5">Click to activate</div>
                            </div>
                        `;
                        toggleBtn.className = 'px-8 py-5 rounded-2xl font-bold text-xl transition-all duration-500 hover:scale-105 hover:shadow-2xl min-w-[200px] flex items-center justify-center border-3 transform shadow-lg';
                        toggleBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        toggleBtn.style.borderColor = '#b91c1c';
                        toggleBtn.style.color = 'white';
                        toggleBtn.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.4)';
                    }
                }
            }
        } else {
            const currentSchedule = document.getElementById('currentSchedule');
            if (currentSchedule) {
                currentSchedule.classList.add('hidden');
            }
            // If no schedule exists, set status badge to active by default
            updateStatusBadge(true);
        }
    })
    .catch(error => {
        console.error('Error loading schedule:', error);
    });
}

// Agent State Management
let agentState = {
    isActive: true, // Default to active
    isLoading: false
};

function toggleAgentState() {
    if (agentState.isLoading) return;
    
    agentState.isLoading = true;
    updateToggleButton(agentState.isActive, true); // Show loading state
    
    const newState = !agentState.isActive;
    
    // Make API call to update agent state
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/toggle-state`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ 
            is_active: newState,
            agent_type: '{{ agent.agent_type }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentState.isActive = newState;
            updateToggleButton(agentState.isActive, false);
            updateStatusBadge(agentState.isActive);
            showToast(
                agentState.isActive ? 'Agent activated! Ready to work.' : 'Agent paused. No triggers will fire.',
                agentState.isActive ? 'success' : 'warning'
            );
        } else {
            throw new Error(data.error || 'Failed to toggle agent state');
        }
    })
    .catch(error => {
        console.error('Error toggling agent state:', error);
        showToast(`Failed to ${newState ? 'activate' : 'pause'} agent: ${error.message}`, 'error');
        // Restore previous state on error
        updateToggleButton(agentState.isActive, false);
    })
    .finally(() => {
        agentState.isLoading = false;
    });
}

function updateToggleButton(isActive, isLoading = false) {
    const toggleBtn = document.getElementById('agentToggleBtn');
    if (!toggleBtn) return;
    
    if (isLoading) {
        toggleBtn.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="text-xl mb-1">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div class="text-sm font-bold tracking-wider">UPDATING...</div>
            </div>
        `;
        toggleBtn.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
        toggleBtn.style.borderColor = '#374151';
        return;
    }
    
    if (isActive) {
        // ACTIVE state - green gradient similar to reference image
        toggleBtn.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="text-xl mb-1">🟢</div>
                <div class="text-sm font-bold tracking-wider">ACTIVE</div>
                <div class="text-xs opacity-90 mt-0.5">Agent Working</div>
            </div>
        `;
        toggleBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        toggleBtn.style.borderColor = '#047857';
        toggleBtn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.4)';
    } else {
        // PAUSED state - red gradient similar to reference image
        toggleBtn.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="text-xl mb-1">🔴</div>
                <div class="text-sm font-bold tracking-wider">PAUSED</div>
                <div class="text-xs opacity-90 mt-0.5">Click to Activate</div>
            </div>
        `;
        toggleBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        toggleBtn.style.borderColor = '#b91c1c';
        toggleBtn.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.4)';
    }
}

function updateStatusBadge(isActive) {
    const statusBadge = document.getElementById('agentStatusBadge');
    if (!statusBadge) return;
    
    console.log('Updating status badge to:', isActive ? 'Active' : 'Paused'); // Debug log
    
    if (isActive) {
        // Green status - Active with modern design and better padding
        statusBadge.className = 'inline-flex items-center px-6 py-3 rounded-xl text-sm font-bold shadow-xl transition-all duration-300';
        statusBadge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        statusBadge.style.color = 'white';
        statusBadge.style.border = '2px solid rgba(255, 255, 255, 0.2)';
        statusBadge.style.backdropFilter = 'blur(10px)';
        statusBadge.innerHTML = `
            <span class="w-3 h-3 rounded-full mr-3 animate-pulse" style="background: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);"></span>
            <span class="tracking-wide">Active & Ready</span>
        `;
    } else {
        // Red status - Paused with modern design and better padding
        statusBadge.className = 'inline-flex items-center px-6 py-3 rounded-xl text-sm font-bold shadow-xl transition-all duration-300';
        statusBadge.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        statusBadge.style.color = 'white';
        statusBadge.style.border = '2px solid rgba(255, 255, 255, 0.2)';
        statusBadge.style.backdropFilter = 'blur(10px)';
        statusBadge.innerHTML = `
            <span class="w-3 h-3 rounded-full mr-3" style="background: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);"></span>
            <span class="tracking-wide">Paused</span>
        `;
    }
}

// Agent state is now managed by the schedule status

// Load current schedule on page load (only for email summarizer agents)
document.addEventListener('DOMContentLoaded', () => {
    // Only load schedule for email summarizer agents
    if (document.querySelector('[data-agent-type="email_summarizer"]')) {
        loadCurrentSchedule();
    } else {
        // For non-email agents, default to active status
        updateStatusBadge(true);
    }
    
    // Load scheduled calls for HubSpot agents
    if (document.querySelector('[data-agent-type="hubspot_data"]')) {
        // Load scheduled calls after a short delay to ensure Alpine.js is ready
        setTimeout(() => {
            if (window.loadScheduledCalls) {
                window.loadScheduledCalls();
            }
        }, 500);
    }
});
</script>
<script>
// Client loader for HubSpot contacts
window.loadHubspotContacts = function() {
    const store = Alpine.store('hubspotData');
    if (!store) return;
    store.loading = true;
    store.error = null;
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/hubspot/contacts`)
        .then(r => r.json())
        .then(data => {
            if (data && data.success) {
                store.contacts = data.contacts || [];
            } else {
                store.error = data.error || 'Failed to load contacts';
            }
        })
        .catch(err => {
            console.error('HubSpot contacts error', err);
            store.error = err.message || 'Failed to load contacts';
        })
        .finally(() => {
            store.loading = false;
        });
}

// Trigger provider call (Bolna API)
window.callContact = function(row) {
    const store = Alpine.store('hubspotData');
    if (!row || !row.phone) {
        showToast('Phone number is required', 'error');
        return;
    }
    store.calling = true;
    store.error = null;
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/hubspot/call`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ 
            phone_number: row.phone, 
            topic: 'follow_up', 
            language: 'en-IN',
            agent_id: '{{ agent.id }}'
        })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            store.error = data.error || 'Failed to initiate call';
            showToast(store.error, 'error');
        } else {
            showToast('Call initiated successfully.', 'success');
        }
    })
    .catch(err => {
        console.error('Initiate call error', err);
        store.error = err.message || 'Failed to initiate call';
        showToast(store.error, 'error');
    })
    .finally(() => {
        store.calling = false;
    });
}

// Call Scheduling Functions
window.loadScheduledCalls = function() {
    const alpine = Alpine.store('callSchedulingData');
    if (!alpine) return;
    
    alpine.loadingSchedules = true;
    alpine.error = null;
    
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules`)
        .then(r => r.json())
        .then(data => {
            if (data && data.success) {
                alpine.scheduledCalls = data.schedules || [];
                showToast(`Loaded ${alpine.scheduledCalls.length} scheduled calls`, 'success');
            } else {
                alpine.error = data.error || 'Failed to load scheduled calls';
                showToast(alpine.error, 'error');
            }
        })
        .catch(err => {
            console.error('Load scheduled calls error', err);
            alpine.error = err.message || 'Failed to load scheduled calls';
            showToast(alpine.error, 'error');
        })
        .finally(() => {
            alpine.loadingSchedules = false;
        });
}

window.createSchedule = function() {
    const alpine = Alpine.store('callSchedulingData');
    if (!alpine) return;
    
    const schedule = alpine.newSchedule;
    if (!schedule.contact_id || !schedule.scheduled_at) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    const toIsoLocal = (value) => {
        // Accept native datetime-local (YYYY-MM-DDTHH:MM) or common DD-MM-YYYY HH:MM
        if (!value) return null;
        // If already looks like YYYY-MM-DDTHH:MM
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(value)) {
            return new Date(value).toISOString();
        }
        // Try DD-MM-YYYY HH:MM
        const m = value.match(/^(\d{2})-(\d{2})-(\d{4})\s+(\d{2}):(\d{2})$/);
        if (m) {
            const [_, d, mo, y, h, mi] = m;
            const isoLike = `${y}-${mo}-${d}T${h}:${mi}:00`;
            return new Date(isoLike).toISOString();
        }
        // Fallback
        try { return new Date(value).toISOString(); } catch { return null; }
    };
    
    // Get contact details
    const contact = Alpine.store('hubspotData').contacts.find(c => c.id === schedule.contact_id);
    if (!contact) {
        showToast('Contact not found', 'error');
        return;
    }
    
    const scheduledIso = toIsoLocal(schedule.scheduled_at);
    if (!scheduledIso) {
        showToast('Invalid scheduled date/time', 'error');
        return;
    }
    
    // Prepare schedule data
    const scheduleData = {
        agent_id: '{{ agent.id }}',
        contact_id: schedule.contact_id,
        contact_name: contact.name,
        contact_phone: contact.phone,
        scheduled_at: scheduledIso,
        call_topic: schedule.call_topic,
        auto_trigger_enabled: schedule.auto_trigger_enabled,
        checkup_threshold_days: Alpine.store('callSchedulingData').callSettings.checkupThresholdDays
    };
    
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(scheduleData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('Schedule saved.', 'success');
            alpine.showScheduleModal = false;
            alpine.resetNewSchedule();
            loadScheduledCalls();
            // Scroll to the call scheduling section
            const section = document.getElementById('call-scheduling-section');
            if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            showToast(data.error || 'Failed to save schedule', 'error');
        }
    })
    .catch(err => {
        console.error('Schedule call error', err);
        showToast('Failed to save schedule', 'error');
    });
}

window.executeCall = function(scheduleId) {
    if (!confirm('Are you sure you want to execute this call now?')) return;
    
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules/${scheduleId}/execute`, {
        method: 'POST',
        headers: { 
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('Call executed successfully!', 'success');
            loadScheduledCalls();
        } else {
            showToast(data.error || 'Failed to execute call', 'error');
        }
    })
    .catch(err => {
        console.error('Execute call error', err);
        showToast('Failed to execute call', 'error');
    });
}

window.deleteSchedule = function(scheduleId) {
    if (!confirm('Are you sure you want to delete this scheduled call?')) return;
    
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules/${scheduleId}`, {
        method: 'DELETE',
        headers: { 
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('Schedule deleted successfully!', 'success');
            loadScheduledCalls();
        } else {
            showToast(data.error || 'Failed to delete schedule', 'error');
        }
    })
    .catch(err => {
        console.error('Delete schedule error', err);
        showToast('Failed to delete schedule', 'error');
    });
}

window.editSchedule = function(schedule) {
    const alpine = Alpine.store('callSchedulingData');
    if (!alpine) return;
    
    // Populate edit form (you can implement a separate edit modal)
    alpine.newSchedule = { ...schedule };
    alpine.showScheduleModal = true;
}

window.saveCallSettings = function() {
    const alpine = Alpine.store('callSchedulingData');
    if (!alpine) return;
    
    // Save settings to localStorage or send to backend
    localStorage.setItem('callSettings', JSON.stringify(alpine.callSettings));
    showToast('Call settings saved!', 'success');
}

window.triggerOverdueCalls = function() {
    if (!confirm('This will trigger all overdue calls based on check-up dates. Continue?')) return;
    
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules/trigger-overdue`, {
        method: 'POST',
        headers: { 
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(`Triggered ${data.count} overdue calls!`, 'success');
            loadScheduledCalls();
        } else {
            showToast(data.error || 'Failed to trigger overdue calls', 'error');
        }
    })
    .catch(err => {
        console.error('Trigger overdue calls error', err);
        showToast('Failed to trigger overdue calls', 'error');
    });
}

window.loadCallStatistics = function() {
    fetch(`/call-scheduling/{{ organization.slug }}/call-schedules/statistics`)
        .then(r => r.json())
        .then(data => {
            if (data && data.success) {
                Alpine.store('callSchedulingData').callStatistics = data.statistics;
            }
        })
        .catch(err => {
            console.error('Load statistics error', err);
        });
}

// Utility functions
window.formatDateTime = function(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    return new Date(dateTimeString).toLocaleString();
}

window.formatDate = function(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

window.getStatusClass = function(status) {
    const classes = {
        'scheduled': 'px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full',
        'in_progress': 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full',
        'completed': 'px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full',
        'failed': 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full',
        'cancelled': 'px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full'
    };
    return classes[status] || classes['scheduled'];
}
</script>
{% endblock %}
